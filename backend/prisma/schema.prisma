generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DIRECTION
  PLANNING
  EQUIPE
  LECTURE
}

enum ContratType {
  ANNUEL
  PONCTUEL
}

enum ContratStatut {
  ACTIF
  SUSPENDU
  TERMINE
}

enum Frequence {
  HEBDOMADAIRE
  MENSUELLE
  TRIMESTRIELLE
  SEMESTRIELLE
  ANNUELLE
  PERSONNALISEE
}

enum InterventionType {
  OPERATION
  CONTROLE
  RECLAMATION
}

enum InterventionStatut {
  A_PLANIFIER
  PLANIFIEE
  REALISEE
  REPORTEE
  ANNULEE
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  tel       String?
  role      Role     @default(EQUIPE)
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contratsResponsable Contrat[]      @relation("ResponsablePlanning")
  interventionsCrees  Intervention[] @relation("CreatedBy")
  interventionsModif  Intervention[] @relation("UpdatedBy")
  auditLogs           AuditLog[]
}

model Employe {
  id        String               @id @default(uuid())
  prenom    String
  nom       String
  postes    Poste[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  interventionEmployes InterventionEmploye[]
}

model Poste {
  id        String    @id @default(uuid())
  nom       String    @unique
  actif     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employes             Employe[]
  interventionEmployes InterventionEmploye[]
}

model Client {
  id              String   @id @default(uuid())
  nomEntreprise   String
  secteur         String?
  siegeNom        String
  siegeAdresse    String?
  siegeTel        String?
  siegeEmail      String?
  siegeNotes      String?
  siegeRC         String?
  siegeNIF        String?
  siegeAI         String?
  siegeNIS        String?
  siegeTIN        String?
  actif           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contrats      Contrat[]
  interventions Intervention[]
  sites         Site[]
  siegeContacts SiegeContact[]
}

model SiegeContact {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])
  nom       String
  fonction  String
  tel       String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

model Site {
  id              String   @id @default(uuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  nom             String
  adresse         String?
  contactNom      String?
  contactFonction String?
  tel             String?
  email           String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contratSites    ContratSite[]
  interventions   Intervention[]

  @@index([clientId])
}

model Contrat {
  id                       String        @id @default(uuid())
  clientId                 String
  client                   Client        @relation(fields: [clientId], references: [id])
  type                     ContratType
  dateDebut                DateTime
  dateFin                  DateTime?
  reconductionAuto         Boolean       @default(false)
  prestations              String[]
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  responsablePlanningId    String?
  responsablePlanning      User?         @relation("ResponsablePlanning", fields: [responsablePlanningId], references: [id])
  statut                   ContratStatut @default(ACTIF)
  notes                    String?
  autoCreerProchaine       Boolean       @default(true)
  // Champs sp√©cifiques au contrat ponctuel
  numeroBonCommande        String?
  nombreOperations         Int?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  interventions Intervention[]
  contratSites  ContratSite[]

  @@index([clientId])
  @@index([statut])
}

model ContratSite {
  id                       String     @id @default(uuid())
  contratId                String
  contrat                  Contrat    @relation(fields: [contratId], references: [id], onDelete: Cascade)
  siteId                   String
  site                     Site       @relation(fields: [siteId], references: [id])
  prestations              String[]   @default([])
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  nombreOperations         Int?
  nombreVisitesControle    Int?
  notes                    String?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  @@unique([contratId, siteId])
  @@index([contratId])
  @@index([siteId])
}

model Intervention {
  id           String             @id @default(uuid())
  contratId    String?
  contrat      Contrat?           @relation(fields: [contratId], references: [id])
  clientId     String
  client       Client             @relation(fields: [clientId], references: [id])
  siteId       String?
  site         Site?              @relation(fields: [siteId], references: [id])
  type         InterventionType
  prestation   String?
  datePrevue   DateTime
  dateRealisee DateTime?
  heurePrevue  String?
  duree        Int?
  statut       InterventionStatut @default(A_PLANIFIER)
  notesTerrain String?
  responsable  String?
  exporteGCal  Boolean            @default(false)
  createdById  String
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById  String?
  updatedBy    User?              @relation("UpdatedBy", fields: [updatedById], references: [id])
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  interventionEmployes InterventionEmploye[]

  @@index([clientId])
  @@index([contratId])
  @@index([siteId])
  @@index([datePrevue])
  @@index([statut])
}

model InterventionEmploye {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  employeId      String
  employe        Employe      @relation(fields: [employeId], references: [id])
  posteId        String
  poste          Poste        @relation(fields: [posteId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([interventionId, employeId, posteId])
  @@index([interventionId])
  @@index([employeId])
}

model Prestation {
  id        String   @id @default(uuid())
  nom       String   @unique
  description String?
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  diff      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}
