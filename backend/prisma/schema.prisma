generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DIRECTION
  PLANNING
  EQUIPE
  LECTURE
}

enum ContratType {
  ANNUEL
  PONCTUEL
}

enum ContratStatut {
  ACTIF
  SUSPENDU
  TERMINE
}

enum Frequence {
  HEBDOMADAIRE
  MENSUELLE
  TRIMESTRIELLE
  SEMESTRIELLE
  ANNUELLE
  PERSONNALISEE
}

enum InterventionType {
  OPERATION
  CONTROLE
  RECLAMATION
  PREMIERE_VISITE
  DEPLACEMENT_COMMERCIAL
}

enum InterventionStatut {
  A_PLANIFIER
  PLANIFIEE
  REALISEE
  REPORTEE
  ANNULEE
}

// ============ TIERS (Dolibarr-inspired) ============

enum TypeTiers {
  CLIENT            // Client uniquement
  FOURNISSEUR       // Fournisseur uniquement
  PROSPECT          // Prospect (client potentiel)
  CLIENT_FOURNISSEUR // Les deux
}

enum FormeJuridique {
  SARL              // Société à responsabilité limitée
  EURL              // Entreprise unipersonnelle
  SPA               // Société par actions
  SNC               // Société en nom collectif
  AUTO_ENTREPRENEUR // Auto-entrepreneur
  ASSOCIATION       // Association
  PARTICULIER       // Personne physique
  AUTRE             // Autre forme
}

enum Civilite {
  M                 // Monsieur
  MME               // Madame
  MLLE              // Mademoiselle
}

enum TypeAdresse {
  SIEGE             // Siège social
  FACTURATION       // Adresse de facturation
  LIVRAISON         // Adresse de livraison
  SITE              // Site d'intervention
}

// Mode de paiement
model ModePaiement {
  id          String   @id @default(uuid())
  code        String   @unique  // VIR, CHQ, ESP, CB, etc.
  libelle     String             // Virement, Chèque, Espèces, etc.
  actif       Boolean  @default(true)
  ordre       Int      @default(0)
  createdAt   DateTime @default(now())

  tiers       Client[] @relation("ModePaiementTiers")
}

// Conditions de paiement
model ConditionPaiement {
  id          String   @id @default(uuid())
  code        String   @unique  // RECEP, 30D, 60D, etc.
  libelle     String             // À réception, 30 jours, etc.
  nbJours     Int      @default(0)  // Nombre de jours
  actif       Boolean  @default(true)
  ordre       Int      @default(0)
  createdAt   DateTime @default(now())

  tiers       Client[] @relation("ConditionPaiementTiers")
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  tel       String?
  role      Role     @default(EQUIPE)
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contratsResponsable Contrat[]        @relation("ResponsablePlanning")
  interventionsCrees  Intervention[]   @relation("CreatedBy")
  interventionsModif  Intervention[]   @relation("UpdatedBy")
  auditLogs           AuditLog[]
  mouvementsStock     MouvementStock[]
  congesApprouves     Conge[]          @relation("ApprouvePar")
}

model Employe {
  id        String               @id @default(uuid())
  prenom    String
  nom       String
  postes    Poste[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  interventionEmployes  InterventionEmploye[]
  conges                Conge[]
  joursWeekendTravailles JourWeekendTravaille[]
  soldesConges          SoldeConge[]
}

model Poste {
  id        String    @id @default(uuid())
  nom       String    @unique
  actif     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employes             Employe[]
  interventionEmployes InterventionEmploye[]
}

model Client {
  id              String   @id @default(uuid())

  // === Identification ===
  code            String?  @unique  // Code client/fournisseur auto-généré
  nomEntreprise   String
  nomAlias        String?           // Nom commercial, enseigne

  // === Type de tiers ===
  typeTiers       TypeTiers @default(CLIENT)

  // === Informations légales ===
  formeJuridique  FormeJuridique?
  siegeRC         String?           // Registre du commerce
  siegeNIF        String?           // Numéro d'identification fiscale
  siegeAI         String?           // Article d'imposition
  siegeNIS        String?           // Numéro d'identification statistique
  siegeTIN        String?           // Tax Identification Number (international)
  tvaIntracom     String?           // TVA intracommunautaire
  capital         Float?            // Capital social
  dateCreation    DateTime?         // Date de création de l'entreprise

  // === Siège social (adresse principale) ===
  siegeNom        String
  siegeAdresse    String?
  siegeCodePostal String?
  siegeVille      String?
  siegePays       String?  @default("Algérie")
  siegeTel        String?
  siegeFax        String?
  siegeEmail      String?
  siegeWebsite    String?
  siegeNotes      String?

  // === Classification ===
  secteur         String?           // Secteur d'activité
  categorie       String?           // Catégorie interne
  codeComptaClient     String?      // Code comptable client
  codeComptaFournisseur String?     // Code comptable fournisseur

  // === Conditions commerciales ===
  modePaiementId       String?
  modePaiement         ModePaiement?      @relation("ModePaiementTiers", fields: [modePaiementId], references: [id])
  conditionPaiementId  String?
  conditionPaiement    ConditionPaiement? @relation("ConditionPaiementTiers", fields: [conditionPaiementId], references: [id])
  remiseParDefaut      Float?       @default(0)   // Remise en %
  encoursMaximum       Float?                      // Limite d'encours autorisé

  // === Devises ===
  devise          String?  @default("DZD")        // Code devise par défaut

  // === Notes ===
  notePublique    String?           // Note visible sur les documents
  notePrivee      String?           // Note interne uniquement

  // === Prospect ===
  prospectNiveau  Int?     @default(0)  // 0=froid, 1=tiède, 2=chaud
  prospectStatut  String?               // Statut commercial du prospect

  // === Statut ===
  actif           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // === Relations ===
  contrats         Contrat[]
  interventions    Intervention[]
  sites            Site[]
  siegeContacts    SiegeContact[]
  adresses         Adresse[]
  comptesBancaires CompteBancaire[]

  @@index([typeTiers])
  @@index([code])
  @@index([nomEntreprise])
}

model SiegeContact {
  id          String    @id @default(uuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Identité ===
  civilite    Civilite?
  nom         String
  prenom      String?
  fonction    String              // Poste/fonction dans l'entreprise

  // === Coordonnées ===
  tel         String?             // Téléphone fixe
  telMobile   String?             // Téléphone mobile
  fax         String?
  email       String?

  // === Informations complémentaires ===
  dateNaissance DateTime?
  notes       String?
  estPrincipal Boolean  @default(false)  // Contact principal
  actif       Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([nom])
}

// Adresses multiples pour un tiers
model Adresse {
  id          String      @id @default(uuid())
  clientId    String
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Type et libellé ===
  type        TypeAdresse @default(SITE)
  libelle     String?               // Nom de l'adresse (ex: "Entrepôt Nord")

  // === Adresse ===
  adresse     String?
  complement  String?               // Complément d'adresse
  codePostal  String?
  ville       String?
  pays        String?     @default("Algérie")

  // === Contact sur place ===
  contactNom  String?
  contactTel  String?
  contactEmail String?

  // === Options ===
  estDefaut   Boolean     @default(false)  // Adresse par défaut pour ce type
  notes       String?
  actif       Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([clientId])
  @@index([type])
}

// Comptes bancaires d'un tiers
model CompteBancaire {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Identification du compte ===
  libelle     String               // Nom du compte (ex: "Compte principal BNA")
  banque      String               // Nom de la banque
  agence      String?              // Agence/domiciliation

  // === RIB (format algérien/français) ===
  codeBanque  String?              // Code banque (5 chiffres)
  codeGuichet String?              // Code guichet (5 chiffres)
  numeroCompte String?             // Numéro de compte
  cleRib      String?              // Clé RIB (2 chiffres)

  // === Format international ===
  iban        String?              // IBAN complet
  bic         String?              // BIC/SWIFT

  // === Titulaire ===
  titulaire   String?              // Nom du titulaire si différent

  // === Options ===
  devise      String?   @default("DZD")
  estDefaut   Boolean   @default(false)  // Compte par défaut
  actif       Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([clientId])
}

model Site {
  id              String   @id @default(uuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])

  // === Identification ===
  code            String?           // Code site unique (ex: SITE001)
  nom             String            // Nom du site

  // === Adresse complète ===
  adresse         String?
  complement      String?           // Complément d'adresse
  codePostal      String?
  ville           String?
  pays            String?  @default("Algérie")

  // === Géolocalisation ===
  latitude        Float?
  longitude       Float?

  // === Informations pratiques ===
  tel             String?           // Téléphone du site
  fax             String?
  email           String?
  horairesOuverture String?         // Ex: "Lun-Ven: 8h-17h"
  accessibilite   String?           // Infos parking, accès, etc.

  // === Notes et statut ===
  notes           String?
  actif           Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // === Relations ===
  contacts        SiteContact[]     // Contacts sur ce site
  contratSites    ContratSite[]
  interventions   Intervention[]

  @@index([clientId])
  @@index([code])
  @@index([ville])
}

// Contacts spécifiques à un site d'intervention
model SiteContact {
  id          String    @id @default(uuid())
  siteId      String
  site        Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // === Identité ===
  civilite    Civilite?
  nom         String
  prenom      String?
  fonction    String?             // Poste/fonction sur le site

  // === Coordonnées ===
  tel         String?             // Téléphone fixe
  telMobile   String?             // Téléphone mobile
  email       String?

  // === Informations complémentaires ===
  notes       String?
  estPrincipal Boolean  @default(false)  // Contact principal du site
  actif       Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([nom])
}

model Contrat {
  id                       String        @id @default(uuid())
  clientId                 String
  client                   Client        @relation(fields: [clientId], references: [id])
  type                     ContratType
  dateDebut                DateTime
  dateFin                  DateTime?
  reconductionAuto         Boolean       @default(false)
  prestations              String[]
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  responsablePlanningId    String?
  responsablePlanning      User?         @relation("ResponsablePlanning", fields: [responsablePlanningId], references: [id])
  statut                   ContratStatut @default(ACTIF)
  notes                    String?
  autoCreerProchaine       Boolean       @default(true)
  // Champs spécifiques au contrat ponctuel
  numeroBonCommande        String?
  nombreOperations         Int?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  interventions Intervention[]
  contratSites  ContratSite[]

  @@index([clientId])
  @@index([statut])
}

model ContratSite {
  id                       String     @id @default(uuid())
  contratId                String
  contrat                  Contrat    @relation(fields: [contratId], references: [id], onDelete: Cascade)
  siteId                   String
  site                     Site       @relation(fields: [siteId], references: [id])
  prestations              String[]   @default([])
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  nombreOperations         Int?
  nombreVisitesControle    Int?
  notes                    String?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  @@unique([contratId, siteId])
  @@index([contratId])
  @@index([siteId])
}

model Intervention {
  id           String             @id @default(uuid())
  contratId    String?
  contrat      Contrat?           @relation(fields: [contratId], references: [id])
  clientId     String
  client       Client             @relation(fields: [clientId], references: [id])
  siteId       String?
  site         Site?              @relation(fields: [siteId], references: [id])
  type         InterventionType
  prestation   String?
  datePrevue   DateTime
  dateRealisee DateTime?
  heurePrevue  String?
  duree        Int?
  statut       InterventionStatut @default(A_PLANIFIER)
  notesTerrain String?
  responsable  String?
  exporteGCal  Boolean            @default(false)
  createdById  String
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById  String?
  updatedBy    User?              @relation("UpdatedBy", fields: [updatedById], references: [id])
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  interventionEmployes InterventionEmploye[]
  mouvementsStock      MouvementStock[]

  @@index([clientId])
  @@index([contratId])
  @@index([siteId])
  @@index([datePrevue])
  @@index([statut])
}

model InterventionEmploye {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  employeId      String
  employe        Employe      @relation(fields: [employeId], references: [id])
  posteId        String
  poste          Poste        @relation(fields: [posteId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([interventionId, employeId, posteId])
  @@index([interventionId])
  @@index([employeId])
}

model Prestation {
  id        String   @id @default(uuid())
  nom       String   @unique
  description String?
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  diff      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}

// ============ GESTION DES STOCKS ============
model Produit {
  id           String           @id @default(uuid())
  reference    String           @unique
  nom          String
  description  String?
  unite        String           @default("unité") // unité, L, Kg, m², etc.
  quantite     Float            @default(0)
  stockMinimum Float            @default(0) // Seuil d'alerte
  prixUnitaire Float?           // Prix unitaire (optionnel)
  actif        Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  mouvements MouvementStock[]

  @@index([reference])
  @@index([nom])
}

enum TypeMouvement {
  ENTREE
  SORTIE
  AJUSTEMENT
}

model MouvementStock {
  id             String         @id @default(uuid())
  produitId      String
  produit        Produit        @relation(fields: [produitId], references: [id])
  type           TypeMouvement
  quantite       Float          // Quantité (toujours positive, le type détermine +/-)
  quantiteAvant  Float          // Stock avant le mouvement
  quantiteApres  Float          // Stock après le mouvement
  motif          String?        // Raison du mouvement
  interventionId String?        // Lien optionnel avec une intervention
  intervention   Intervention?  @relation(fields: [interventionId], references: [id])
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  createdAt      DateTime       @default(now())

  @@index([produitId])
  @@index([interventionId])
  @@index([userId])
  @@index([createdAt])
}

// ============ GESTION RH - CONGES ET RECUPERATION ============

enum TypeConge {
  ANNUEL           // Congé annuel
  MALADIE          // Arrêt maladie
  RECUPERATION     // Jour de récupération (weekend travaillé)
  SANS_SOLDE       // Congé sans solde
  EXCEPTIONNEL     // Événement familial, etc.
}

enum StatutConge {
  EN_ATTENTE
  APPROUVE
  REFUSE
  ANNULE
}

model Conge {
  id          String       @id @default(uuid())
  employeId   String
  employe     Employe      @relation(fields: [employeId], references: [id])
  type        TypeConge
  dateDebut   DateTime
  dateFin     DateTime
  nbJours     Float        // Nombre de jours (peut être 0.5 pour demi-journée)
  motif       String?
  statut      StatutConge  @default(EN_ATTENTE)
  approuveParId String?
  approuvePar User?        @relation("ApprouvePar", fields: [approuveParId], references: [id])
  dateReponse DateTime?
  commentaire String?      // Commentaire lors de l'approbation/refus
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([employeId])
  @@index([dateDebut])
  @@index([statut])
}

// Suivi des jours de weekend travaillés
model JourWeekendTravaille {
  id          String   @id @default(uuid())
  employeId   String
  employe     Employe  @relation(fields: [employeId], references: [id])
  date        DateTime // La date du jour travaillé (vendredi ou samedi)
  estVendredi Boolean  // true = vendredi, false = samedi
  notes       String?
  createdAt   DateTime @default(now())

  @@unique([employeId, date]) // Un employé ne peut avoir qu'une entrée par jour
  @@index([employeId])
  @@index([date])
}

// Solde des congés par employé et par année
model SoldeConge {
  id              String    @id @default(uuid())
  employeId       String
  employe         Employe   @relation(fields: [employeId], references: [id])
  annee           Int       // L'année concernée
  type            TypeConge
  joursAcquis     Float     @default(0) // Jours acquis/alloués
  joursPris       Float     @default(0) // Jours utilisés
  joursRestants   Float     @default(0) // Calculé: acquis - pris
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeId, annee, type])
  @@index([employeId])
  @@index([annee])
}
