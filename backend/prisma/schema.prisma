generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DIRECTION
  PLANNING
  EQUIPE
  LECTURE
}

enum ContratType {
  ANNUEL
  PONCTUEL
}

enum ContratStatut {
  ACTIF
  SUSPENDU
  TERMINE
}

enum Frequence {
  HEBDOMADAIRE
  MENSUELLE
  TRIMESTRIELLE
  SEMESTRIELLE
  ANNUELLE
  PERSONNALISEE
}

enum InterventionType {
  OPERATION
  CONTROLE
  RECLAMATION
  PREMIERE_VISITE
  DEPLACEMENT_COMMERCIAL
}

enum InterventionStatut {
  A_PLANIFIER
  PLANIFIEE
  REALISEE
  REPORTEE
  ANNULEE
}

// ============ TIERS (Dolibarr-inspired) ============

enum TypeTiers {
  CLIENT            // Client uniquement
  FOURNISSEUR       // Fournisseur uniquement
  PROSPECT          // Prospect (client potentiel)
  CLIENT_FOURNISSEUR // Les deux
}

enum FormeJuridique {
  SARL              // Société à responsabilité limitée
  EURL              // Entreprise unipersonnelle
  SPA               // Société par actions
  SNC               // Société en nom collectif
  AUTO_ENTREPRENEUR // Auto-entrepreneur
  ASSOCIATION       // Association
  PARTICULIER       // Personne physique
  AUTRE             // Autre forme
}

enum Civilite {
  M                 // Monsieur
  MME               // Madame
  MLLE              // Mademoiselle
}

enum TypeAdresse {
  SIEGE             // Siège social
  FACTURATION       // Adresse de facturation
  LIVRAISON         // Adresse de livraison
  SITE              // Site d'intervention
}

// ============ COMMERCE (Dolibarr-inspired) ============

enum DocumentType {
  DEVIS
  COMMANDE
  FACTURE
  FACTURE_AVOIR
  COMMANDE_FOURNISSEUR
  FACTURE_FOURNISSEUR
  CHARGE
  PAIEMENT_DIVERS
}

enum DevisStatut {
  BROUILLON
  VALIDE
  SIGNE
  REFUSE
  EXPIRE
  ANNULE
}

enum CommandeStatut {
  BROUILLON
  VALIDEE
  EN_PREPARATION
  EXPEDIEE
  LIVREE
  ANNULEE
}

enum FactureStatut {
  BROUILLON
  VALIDEE
  EN_RETARD
  PARTIELLEMENT_PAYEE
  PAYEE
  ANNULEE
}

enum FactureType {
  FACTURE
  AVOIR
  ACOMPTE    // Facture d'acompte
}

enum PaiementStatut {
  RECU
  ANNULE
}

// Mode de paiement
model ModePaiement {
  id          String   @id @default(uuid())
  code        String   @unique  // VIR, CHQ, ESP, CB, etc.
  libelle     String             // Virement, Chèque, Espèces, etc.
  actif       Boolean  @default(true)
  ordre       Int      @default(0)
  createdAt   DateTime @default(now())

  tiers                Client[]              @relation("ModePaiementTiers")
  paiements            Paiement[]
  paiementsFournisseur PaiementFournisseur[] @relation("PaiementsFournisseur")
  paiementsCharge      PaiementCharge[]      @relation("PaiementsCharge")
  paiementsDivers      PaiementDivers[]      @relation("PaiementsDivers")
}

// Conditions de paiement
model ConditionPaiement {
  id          String   @id @default(uuid())
  code        String   @unique  // RECEP, 30D, 60D, etc.
  libelle     String             // À réception, 30 jours, etc.
  nbJours     Int      @default(0)  // Nombre de jours
  actif       Boolean  @default(true)
  ordre       Int      @default(0)
  createdAt   DateTime @default(now())

  tiers       Client[] @relation("ConditionPaiementTiers")
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  tel       String?
  role      Role     @default(EQUIPE)
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contratsResponsable Contrat[]        @relation("ResponsablePlanning")
  interventionsCrees  Intervention[]   @relation("CreatedBy")
  interventionsModif  Intervention[]   @relation("UpdatedBy")
  auditLogs           AuditLog[]
  mouvementsStock     MouvementStock[]
  congesApprouves     Conge[]          @relation("ApprouvePar")

  // Commerce
  devisCrees          Devis[]          @relation("DevisCreatedBy")
  devisModifies       Devis[]          @relation("DevisUpdatedBy")
  commandesCrees      Commande[]       @relation("CommandeCreatedBy")
  commandesModifies   Commande[]       @relation("CommandeUpdatedBy")
  facturesCrees       Facture[]        @relation("FactureCreatedBy")
  facturesModifies    Facture[]        @relation("FactureUpdatedBy")
  paiementsCrees      Paiement[]       @relation("PaiementCreatedBy")
  facturesRelancees   FactureRelance[] @relation("FactureRelanceCreatedBy")
  commandesFournisseurCrees    CommandeFournisseur[] @relation("CommandeFournisseurCreatedBy")
  commandesFournisseurModifies CommandeFournisseur[] @relation("CommandeFournisseurUpdatedBy")

  // Facturation
  facturesFournisseurCrees    FactureFournisseur[]  @relation("FactureFournisseurCreatedBy")
  facturesFournisseurModifies FactureFournisseur[]  @relation("FactureFournisseurUpdatedBy")
  paiementsFournisseurCrees   PaiementFournisseur[] @relation("PaiementFournisseurCreatedBy")
  chargesCrees                Charge[]              @relation("ChargeCreatedBy")
  chargesModifies             Charge[]              @relation("ChargeUpdatedBy")
  paiementsChargeCrees        PaiementCharge[]      @relation("PaiementChargeCreatedBy")
  paiementsDiversCrees        PaiementDivers[]      @relation("PaiementDiversCreatedBy")
}

model Employe {
  id        String               @id @default(uuid())
  prenom    String
  nom       String
  postes    Poste[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  interventionEmployes  InterventionEmploye[]
  conges                Conge[]
  joursWeekendTravailles JourWeekendTravaille[]
  soldesConges          SoldeConge[]
}

model Poste {
  id        String    @id @default(uuid())
  nom       String    @unique
  actif     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employes             Employe[]
  interventionEmployes InterventionEmploye[]
}

model Client {
  id              String   @id @default(uuid())

  // === Identification ===
  code            String?  @unique  // Code client/fournisseur auto-généré
  nomEntreprise   String
  nomAlias        String?           // Nom commercial, enseigne

  // === Type de tiers ===
  typeTiers       TypeTiers @default(CLIENT)

  // === Informations légales ===
  formeJuridique  FormeJuridique?
  siegeRC         String?           // Registre du commerce
  siegeNIF        String?           // Numéro d'identification fiscale
  siegeAI         String?           // Article d'imposition
  siegeNIS        String?           // Numéro d'identification statistique
  siegeTIN        String?           // Tax Identification Number (international)
  tvaIntracom     String?           // TVA intracommunautaire
  capital         Float?            // Capital social
  dateCreation    DateTime?         // Date de création de l'entreprise

  // === Siège social (adresse principale) ===
  siegeNom        String
  siegeAdresse    String?
  siegeCodePostal String?
  siegeVille      String?
  siegePays       String?  @default("Algérie")
  siegeTel        String?
  siegeFax        String?
  siegeEmail      String?
  siegeWebsite    String?
  siegeNotes      String?

  // === Classification ===
  secteur         String?           // Secteur d'activité
  categorie       String?           // Catégorie interne
  codeComptaClient     String?      // Code comptable client
  codeComptaFournisseur String?     // Code comptable fournisseur

  // === Conditions commerciales ===
  modePaiementId       String?
  modePaiement         ModePaiement?      @relation("ModePaiementTiers", fields: [modePaiementId], references: [id])
  conditionPaiementId  String?
  conditionPaiement    ConditionPaiement? @relation("ConditionPaiementTiers", fields: [conditionPaiementId], references: [id])
  remiseParDefaut      Float?       @default(0)   // Remise en %
  encoursMaximum       Float?                      // Limite d'encours autorisé

  // === Devises ===
  devise          String?  @default("DZD")        // Code devise par défaut

  // === Notes ===
  notePublique    String?           // Note visible sur les documents
  notePrivee      String?           // Note interne uniquement

  // === Prospect ===
  prospectNiveau  Int?     @default(0)  // 0=froid, 1=tiède, 2=chaud
  prospectStatut  String?               // Statut commercial du prospect

  // === Statut ===
  actif           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // === Relations ===
  contrats         Contrat[]
  interventions    Intervention[]
  sites            Site[]
  siegeContacts    SiegeContact[]
  adresses         Adresse[]
  comptesBancaires CompteBancaire[]

  // Relations produits/services (Dolibarr-style)
  produitsFournis           ProduitService[]           @relation("FournisseurProduit")
  produitsDefautFournisseur ProduitFournisseurDefaut[] @relation("FournisseurDefautProduit")
  prixFournisseur           PrixFournisseur[]          @relation("PrixFournisseurTiers")
  prixClient                PrixClient[]               @relation("PrixClientTiers")

  // Commerce
  devis            Devis[]
  commandes        Commande[]
  factures         Facture[]
  commandesFournisseur CommandeFournisseur[] @relation("CommandesFournisseur")
  facturesFournisseur  FactureFournisseur[]  @relation("FacturesFournisseur")
  charges              Charge[]              @relation("ChargesFournisseur")
  paiementsDivers      PaiementDivers[]      @relation("PaiementsDivers")

  @@index([typeTiers])
  @@index([code])
  @@index([nomEntreprise])
}

model SiegeContact {
  id          String    @id @default(uuid())
  clientId    String
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Identité ===
  civilite    Civilite?
  nom         String
  prenom      String?
  fonction    String              // Poste/fonction dans l'entreprise

  // === Coordonnées ===
  tel         String?             // Téléphone fixe
  telMobile   String?             // Téléphone mobile
  fax         String?
  email       String?

  // === Informations complémentaires ===
  dateNaissance DateTime?
  notes       String?
  estPrincipal Boolean  @default(false)  // Contact principal
  actif       Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([clientId])
  @@index([nom])
}

// Adresses multiples pour un tiers
model Adresse {
  id          String      @id @default(uuid())
  clientId    String
  client      Client      @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Type et libellé ===
  type        TypeAdresse @default(SITE)
  libelle     String?               // Nom de l'adresse (ex: "Entrepôt Nord")

  // === Adresse ===
  adresse     String?
  complement  String?               // Complément d'adresse
  codePostal  String?
  ville       String?
  pays        String?     @default("Algérie")

  // === Contact sur place ===
  contactNom  String?
  contactTel  String?
  contactEmail String?

  // === Options ===
  estDefaut   Boolean     @default(false)  // Adresse par défaut pour ce type
  notes       String?
  actif       Boolean     @default(true)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  // Commerce
  devisFacturation     Devis[]    @relation("DevisAdresseFacturation")
  devisLivraison       Devis[]    @relation("DevisAdresseLivraison")
  commandesFacturation Commande[] @relation("CommandeAdresseFacturation")
  commandesLivraison   Commande[] @relation("CommandeAdresseLivraison")
  facturesFacturation  Facture[]  @relation("FactureAdresseFacturation")
  facturesLivraison    Facture[]  @relation("FactureAdresseLivraison")

  @@index([clientId])
  @@index([type])
}

// Comptes bancaires d'un tiers
model CompteBancaire {
  id          String   @id @default(uuid())
  clientId    String
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  // === Identification du compte ===
  libelle     String               // Nom du compte (ex: "Compte principal BNA")
  banque      String               // Nom de la banque
  agence      String?              // Agence/domiciliation

  // === RIB (format algérien/français) ===
  codeBanque  String?              // Code banque (5 chiffres)
  codeGuichet String?              // Code guichet (5 chiffres)
  numeroCompte String?             // Numéro de compte
  cleRib      String?              // Clé RIB (2 chiffres)

  // === Format international ===
  iban        String?              // IBAN complet
  bic         String?              // BIC/SWIFT

  // === Titulaire ===
  titulaire   String?              // Nom du titulaire si différent

  // === Options ===
  devise      String?   @default("DZD")
  estDefaut   Boolean   @default(false)  // Compte par défaut
  actif       Boolean   @default(true)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([clientId])
}

model Site {
  id              String   @id @default(uuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])

  // === Identification ===
  code            String?           // Code site unique (ex: SITE001)
  nom             String            // Nom du site

  // === Adresse complète ===
  adresse         String?
  complement      String?           // Complément d'adresse
  codePostal      String?
  ville           String?
  pays            String?  @default("Algérie")

  // === Géolocalisation ===
  latitude        Float?
  longitude       Float?

  // === Informations pratiques ===
  tel             String?           // Téléphone du site
  fax             String?
  email           String?
  horairesOuverture String?         // Ex: "Lun-Ven: 8h-17h"
  accessibilite   String?           // Infos parking, accès, etc.

  // === Notes et statut ===
  notes           String?
  actif           Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // === Relations ===
  contacts        SiteContact[]     // Contacts sur ce site
  contratSites    ContratSite[]
  interventions   Intervention[]

  @@index([clientId])
  @@index([code])
  @@index([ville])
}

// Contacts spécifiques à un site d'intervention
model SiteContact {
  id          String    @id @default(uuid())
  siteId      String
  site        Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  // === Identité ===
  civilite    Civilite?
  nom         String
  prenom      String?
  fonction    String?             // Poste/fonction sur le site

  // === Coordonnées ===
  tel         String?             // Téléphone fixe
  telMobile   String?             // Téléphone mobile
  email       String?

  // === Informations complémentaires ===
  notes       String?
  estPrincipal Boolean  @default(false)  // Contact principal du site
  actif       Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([siteId])
  @@index([nom])
}

model Contrat {
  id                       String        @id @default(uuid())
  clientId                 String
  client                   Client        @relation(fields: [clientId], references: [id])
  type                     ContratType
  dateDebut                DateTime
  dateFin                  DateTime?
  reconductionAuto         Boolean       @default(false)
  prestations              String[]
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  responsablePlanningId    String?
  responsablePlanning      User?         @relation("ResponsablePlanning", fields: [responsablePlanningId], references: [id])
  statut                   ContratStatut @default(ACTIF)
  notes                    String?
  autoCreerProchaine       Boolean       @default(true)
  // Champs spécifiques au contrat ponctuel
  numeroBonCommande        String?
  nombreOperations         Int?
  nombreVisitesControle    Int?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  interventions Intervention[]
  contratSites  ContratSite[]

  @@index([clientId])
  @@index([statut])
}

model ContratSite {
  id                       String     @id @default(uuid())
  contratId                String
  contrat                  Contrat    @relation(fields: [contratId], references: [id], onDelete: Cascade)
  siteId                   String
  site                     Site       @relation(fields: [siteId], references: [id])
  prestations              String[]   @default([])
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  nombreOperations         Int?
  nombreVisitesControle    Int?
  notes                    String?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  @@unique([contratId, siteId])
  @@index([contratId])
  @@index([siteId])
}

model Intervention {
  id           String             @id @default(uuid())
  contratId    String?
  contrat      Contrat?           @relation(fields: [contratId], references: [id])
  clientId     String
  client       Client             @relation(fields: [clientId], references: [id])
  siteId       String?
  site         Site?              @relation(fields: [siteId], references: [id])
  type         InterventionType
  prestation   String?
  datePrevue   DateTime
  dateRealisee DateTime?
  heurePrevue  String?
  duree        Int?
  statut       InterventionStatut @default(A_PLANIFIER)
  notesTerrain String?
  responsable  String?
  exporteGCal  Boolean            @default(false)
  createdById  String
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById  String?
  updatedBy    User?              @relation("UpdatedBy", fields: [updatedById], references: [id])
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  interventionEmployes InterventionEmploye[]
  mouvementsStock      MouvementStock[]

  @@index([clientId])
  @@index([contratId])
  @@index([siteId])
  @@index([datePrevue])
  @@index([statut])
}

model InterventionEmploye {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  employeId      String
  employe        Employe      @relation(fields: [employeId], references: [id])
  posteId        String
  poste          Poste        @relation(fields: [posteId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([interventionId, employeId, posteId])
  @@index([interventionId])
  @@index([employeId])
}

model Prestation {
  id        String   @id @default(uuid())
  nom       String   @unique
  description String?
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  diff      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}

// ============ GESTION DES PRODUITS/SERVICES (Dolibarr-inspired) ============

enum TypeProduit {
  PRODUIT              // Article physique avec gestion de stock
  SERVICE              // Prestation immatérielle sans stock
}

enum NatureProduit {
  CONSOMMABLE                // Produit consommable (produits chimiques, etc.)
  EPI                        // Équipement de Protection Individuelle
  MATERIEL_ANTI_NUISIBLES    // Matériel anti-nuisibles (fly killer, pièges, pics pigeons, etc.)
}

// Catégories de produits/services (hiérarchique)
model CategorieProduit {
  id           String             @id @default(uuid())
  code         String?            @unique
  nom          String
  description  String?
  parentId     String?
  parent       CategorieProduit?  @relation("CategorieHierarchie", fields: [parentId], references: [id])
  enfants      CategorieProduit[] @relation("CategorieHierarchie")
  couleur      String?            // Couleur pour affichage (hex)
  icone        String?            // Icône (nom lucide-react)
  ordre        Int                @default(0)
  actif        Boolean            @default(true)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  produits     ProduitServiceCategorie[]

  @@index([parentId])
  @@index([nom])
}

// Table de liaison Produit-Catégorie (many-to-many)
model ProduitServiceCategorie {
  id          String           @id @default(uuid())
  produitId   String
  produit     ProduitService   @relation(fields: [produitId], references: [id], onDelete: Cascade)
  categorieId String
  categorie   CategorieProduit @relation(fields: [categorieId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now())

  @@unique([produitId, categorieId])
  @@index([produitId])
  @@index([categorieId])
}

// Entrepôts pour gestion multi-stocks
model Entrepot {
  id           String           @id @default(uuid())
  code         String           @unique
  nom          String
  description  String?
  adresse      String?
  codePostal   String?
  ville        String?
  pays         String?          @default("Algérie")
  responsable  String?          // Nom du responsable
  tel          String?
  email        String?
  estDefaut    Boolean          @default(false)
  actif        Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  stocks       StockEntrepot[]
  mouvements   MouvementStock[]

  @@index([code])
  @@index([nom])
}

// Stock par entrepôt
model StockEntrepot {
  id           String         @id @default(uuid())
  produitId    String
  produit      ProduitService @relation(fields: [produitId], references: [id], onDelete: Cascade)
  entrepotId   String
  entrepot     Entrepot       @relation(fields: [entrepotId], references: [id], onDelete: Cascade)
  quantite     Float          @default(0)
  emplacement  String?        // Emplacement dans l'entrepôt (ex: A1-B2)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([produitId, entrepotId])
  @@index([produitId])
  @@index([entrepotId])
}

// Modèle enrichi Produit/Service (remplace l'ancien Produit)
model ProduitService {
  id              String          @id @default(uuid())

  // === Identification ===
  reference       String          @unique
  codeBarres      String?         @unique   // Code-barres EAN13, UPC, etc.
  nom             String
  description     String?
  descriptionLongue String?                 // Description détaillée pour devis/factures

  // === Type et nature ===
  type            TypeProduit     @default(PRODUIT)
  nature          NatureProduit?            // Nature du produit

  // === Unités ===
  unite           String          @default("unité")  // Unité de vente (unité, L, Kg, m², h, etc.)
  uniteAchat      String?                            // Unité d'achat si différente
  ratioUnites     Float?          @default(1)        // Ratio unité achat / unité vente

  // === Prix de vente ===
  prixVenteHT     Float?                    // Prix de vente HT
  tauxTVA         Float?          @default(19)  // Taux TVA en % (19% par défaut en Algérie)
  prixVenteTTC    Float?                    // Prix TTC (calculé)

  // === Prix d'achat ===
  prixAchatHT     Float?                    // Prix d'achat moyen HT
  margeParDefaut  Float?                    // Marge en %

  // === Stock (pour type PRODUIT) ===
  aStock          Boolean         @default(true)    // Gérer le stock (false pour services)
  quantite        Float           @default(0)       // Quantité totale en stock
  stockMinimum    Float           @default(0)       // Seuil d'alerte
  stockMaximum    Float?                            // Stock maximum souhaité
  lotSuivi        Boolean         @default(false)   // Suivi par lot/série
  dlcSuivi        Boolean         @default(false)   // Suivi date limite consommation

  // === Service spécifique ===
  dureeService    Float?                    // Durée du service (en heures)

  // === Fournisseur par défaut ===
  fournisseurId   String?
  fournisseur     Client?         @relation("FournisseurProduit", fields: [fournisseurId], references: [id])
  delaiLivraison  Int?                      // Délai de livraison en jours

  // === Classification ===
  marque          String?                   // Marque
  modele          String?                   // Modèle
  poids           Float?                    // Poids en kg
  longueur        Float?                    // Dimensions en cm
  largeur         Float?
  hauteur         Float?

  // === Comptabilité ===
  compteVente     String?                   // Compte comptable vente
  compteAchat     String?                   // Compte comptable achat

  // === Notes et fichiers ===
  notePublique    String?                   // Note sur documents
  notePrivee      String?                   // Note interne
  urlExterne      String?                   // Lien vers documentation externe

  // === Statut ===
  enVente         Boolean         @default(true)    // Peut être vendu
  enAchat         Boolean         @default(true)    // Peut être acheté
  actif           Boolean         @default(true)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // === Relations ===
  categories      ProduitServiceCategorie[]
  prixFournisseurs PrixFournisseur[]
  prixClients     PrixClient[]
  stocks          StockEntrepot[]
  mouvements      MouvementStock[]
  lots            LotProduit[]
  devisLignes     DevisLigne[]
  commandeLignes  CommandeLigne[]
  factureLignes   FactureLigne[]
  commandeFournisseurLignes   CommandeFournisseurLigne[]
  factureFournisseurLignes    FactureFournisseurLigne[] @relation("FactureFournisseurLignes")

  fournisseursDefaut ProduitFournisseurDefaut[]

  @@index([reference])
  @@index([codeBarres])
  @@index([nom])
  @@index([type])
  @@index([fournisseurId])
}

// Fournisseurs par défaut avec ordre de préférence
model ProduitFournisseurDefaut {
  id            String         @id @default(uuid())
  produitId     String
  produit       ProduitService @relation(fields: [produitId], references: [id], onDelete: Cascade)
  fournisseurId String
  fournisseur   Client         @relation("FournisseurDefautProduit", fields: [fournisseurId], references: [id], onDelete: Cascade)
  ordre         Int            @default(1)  // 1 = premier choix, 2 = second, etc.
  createdAt     DateTime       @default(now())

  @@unique([produitId, fournisseurId])
  @@index([produitId])
  @@index([fournisseurId])
  @@index([ordre])
}

// Prix par fournisseur
model PrixFournisseur {
  id            String         @id @default(uuid())
  produitId     String
  produit       ProduitService @relation(fields: [produitId], references: [id], onDelete: Cascade)
  fournisseurId String
  fournisseur   Client         @relation("PrixFournisseurTiers", fields: [fournisseurId], references: [id], onDelete: Cascade)

  refFournisseur String?                   // Référence chez le fournisseur
  prixAchatHT    Float                     // Prix d'achat HT
  remise         Float?         @default(0) // Remise en %
  quantiteMin    Float?         @default(1) // Quantité minimum de commande
  delaiLivraison Int?                       // Délai en jours
  dateDebut      DateTime?                  // Date début validité prix
  dateFin        DateTime?                  // Date fin validité prix
  estDefaut      Boolean        @default(false)  // Fournisseur par défaut pour ce produit
  notes          String?
  actif          Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([produitId, fournisseurId])
  @@index([produitId])
  @@index([fournisseurId])
}

// Prix spécifiques par client
model PrixClient {
  id            String         @id @default(uuid())
  produitId     String
  produit       ProduitService @relation(fields: [produitId], references: [id], onDelete: Cascade)
  clientId      String
  client        Client         @relation("PrixClientTiers", fields: [clientId], references: [id], onDelete: Cascade)

  prixVenteHT   Float                      // Prix de vente spécifique HT
  remise        Float?         @default(0) // Remise additionnelle en %
  quantiteMin   Float?         @default(1) // Quantité minimum
  dateDebut     DateTime?                  // Date début validité
  dateFin       DateTime?                  // Date fin validité
  notes         String?
  actif         Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([produitId, clientId])
  @@index([produitId])
  @@index([clientId])
}

// Lots et numéros de série
model LotProduit {
  id            String         @id @default(uuid())
  produitId     String
  produit       ProduitService @relation(fields: [produitId], references: [id], onDelete: Cascade)

  numeroLot     String                     // Numéro de lot ou série
  quantite      Float          @default(0) // Quantité dans ce lot
  datePeremption DateTime?                 // Date de péremption
  dateFabrication DateTime?                // Date de fabrication
  notes         String?
  actif         Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([produitId, numeroLot])
  @@index([produitId])
  @@index([numeroLot])
}

// ============ ANCIEN MODELE PRODUIT (conservé pour compatibilité stock existant) ============
model Produit {
  id           String           @id @default(uuid())
  reference    String           @unique
  nom          String
  description  String?
  unite        String           @default("unité") // unité, L, Kg, m², etc.
  quantite     Float            @default(0)
  stockMinimum Float            @default(0) // Seuil d'alerte
  prixUnitaire Float?           // Prix unitaire (optionnel)
  actif        Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  mouvements MouvementStock[]

  @@index([reference])
  @@index([nom])
}

enum TypeMouvement {
  ENTREE
  SORTIE
  AJUSTEMENT
  TRANSFERT       // Transfert entre entrepôts
  INVENTAIRE      // Correction d'inventaire
}

model MouvementStock {
  id               String          @id @default(uuid())
  // Support ancien modèle Produit
  produitId        String?
  produit          Produit?        @relation(fields: [produitId], references: [id])
  // Support nouveau modèle ProduitService
  produitServiceId String?
  produitService   ProduitService? @relation(fields: [produitServiceId], references: [id])
  // Entrepôt (pour gestion multi-entrepôts)
  entrepotId       String?
  entrepot         Entrepot?       @relation(fields: [entrepotId], references: [id])
  entrepotDestId   String?         // Pour les transferts

  type             TypeMouvement
  quantite         Float           // Quantité (toujours positive, le type détermine +/-)
  quantiteAvant    Float           // Stock avant le mouvement
  quantiteApres    Float           // Stock après le mouvement
  motif            String?         // Raison du mouvement
  numeroLot        String?         // Numéro de lot si applicable
  interventionId   String?         // Lien optionnel avec une intervention
  intervention     Intervention?   @relation(fields: [interventionId], references: [id])
  userId           String
  user             User            @relation(fields: [userId], references: [id])
  createdAt        DateTime        @default(now())

  @@index([produitId])
  @@index([produitServiceId])
  @@index([entrepotId])
  @@index([interventionId])
  @@index([userId])
  @@index([createdAt])
}

// ============ COMMERCE (Devis, Commandes, Factures) ============

model CompteurDocument {
  id             String       @id @default(uuid())
  type           DocumentType
  annee          Int
  prochainNumero Int          @default(1)
  updatedAt      DateTime     @updatedAt

  @@unique([type, annee])
  @@index([type])
  @@index([annee])
}

model Devis {
  id                   String       @id @default(uuid())
  ref                  String       @unique
  clientId             String
  client               Client       @relation(fields: [clientId], references: [id])
  adresseFacturationId String?
  adresseFacturation   Adresse?     @relation("DevisAdresseFacturation", fields: [adresseFacturationId], references: [id])
  adresseLivraisonId   String?
  adresseLivraison     Adresse?     @relation("DevisAdresseLivraison", fields: [adresseLivraisonId], references: [id])
  dateDevis            DateTime     @default(now())
  dateValidite         DateTime?
  statut               DevisStatut  @default(BROUILLON)
  remiseGlobalPct      Float?       @default(0)
  remiseGlobalMontant  Float?       @default(0)
  totalHT              Float        @default(0)
  totalTVA             Float        @default(0)
  totalTTC             Float        @default(0)
  devise               String?      @default("DZD")
  notes                String?
  conditions           String?
  createdById          String?
  createdBy            User?        @relation("DevisCreatedBy", fields: [createdById], references: [id])
  updatedById          String?
  updatedBy            User?        @relation("DevisUpdatedBy", fields: [updatedById], references: [id])
  createdAt            DateTime     @default(now())
  updatedAt            DateTime     @updatedAt

  lignes               DevisLigne[]
  commandes            Commande[]
  factures             Facture[]

  @@index([clientId])
  @@index([statut])
  @@index([ref])
  @@index([dateDevis])
}

model DevisLigne {
  id               String         @id @default(uuid())
  devisId          String
  devis            Devis          @relation(fields: [devisId], references: [id], onDelete: Cascade)
  produitServiceId String?
  produitService   ProduitService? @relation(fields: [produitServiceId], references: [id])
  libelle          String
  description      String?
  quantite         Float          @default(1)
  unite            String?
  prixUnitaireHT   Float          @default(0)
  tauxTVA          Float          @default(0)
  remisePct        Float?         @default(0)
  totalHT          Float          @default(0)
  totalTVA         Float          @default(0)
  totalTTC         Float          @default(0)
  ordre            Int            @default(0)

  @@index([devisId])
  @@index([produitServiceId])
}

model Commande {
  id                   String          @id @default(uuid())
  ref                  String          @unique
  clientId             String
  client               Client          @relation(fields: [clientId], references: [id])
  devisId              String?
  devis                Devis?          @relation(fields: [devisId], references: [id])
  adresseFacturationId String?
  adresseFacturation   Adresse?        @relation("CommandeAdresseFacturation", fields: [adresseFacturationId], references: [id])
  adresseLivraisonId   String?
  adresseLivraison     Adresse?        @relation("CommandeAdresseLivraison", fields: [adresseLivraisonId], references: [id])
  dateCommande         DateTime        @default(now())
  dateLivraisonSouhaitee DateTime?
  refBonCommandeClient String?         // Numéro du bon de commande client (obligatoire à la validation)
  statut               CommandeStatut  @default(BROUILLON)
  remiseGlobalPct      Float?          @default(0)
  remiseGlobalMontant  Float?          @default(0)
  totalHT              Float           @default(0)
  totalTVA             Float           @default(0)
  totalTTC             Float           @default(0)
  devise               String?         @default("DZD")
  notes                String?
  conditions           String?
  createdById          String?
  createdBy            User?           @relation("CommandeCreatedBy", fields: [createdById], references: [id])
  updatedById          String?
  updatedBy            User?           @relation("CommandeUpdatedBy", fields: [updatedById], references: [id])
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  lignes               CommandeLigne[]
  factures             Facture[]

  @@index([clientId])
  @@index([statut])
  @@index([ref])
  @@index([dateCommande])
}

model CommandeLigne {
  id               String         @id @default(uuid())
  commandeId       String
  commande         Commande       @relation(fields: [commandeId], references: [id], onDelete: Cascade)
  produitServiceId String?
  produitService   ProduitService? @relation(fields: [produitServiceId], references: [id])
  libelle          String
  description      String?
  quantite         Float          @default(1)
  unite            String?
  prixUnitaireHT   Float          @default(0)
  tauxTVA          Float          @default(0)
  remisePct        Float?         @default(0)
  totalHT          Float          @default(0)
  totalTVA         Float          @default(0)
  totalTTC         Float          @default(0)
  ordre            Int            @default(0)

  @@index([commandeId])
  @@index([produitServiceId])
}

model Facture {
  id                   String        @id @default(uuid())
  ref                  String        @unique
  clientId             String
  client               Client        @relation(fields: [clientId], references: [id])
  devisId              String?
  devis                Devis?        @relation(fields: [devisId], references: [id])
  commandeId           String?
  commande             Commande?     @relation(fields: [commandeId], references: [id])
  adresseFacturationId String?
  adresseFacturation   Adresse?      @relation("FactureAdresseFacturation", fields: [adresseFacturationId], references: [id])
  adresseLivraisonId   String?
  adresseLivraison     Adresse?      @relation("FactureAdresseLivraison", fields: [adresseLivraisonId], references: [id])
  dateFacture          DateTime      @default(now())
  dateEcheance         DateTime?
  delaiPaiementJours   Int?          @default(45)  // Délai de paiement en jours
  type                 FactureType   @default(FACTURE)
  statut               FactureStatut @default(BROUILLON)
  remiseGlobalPct      Float?        @default(0)
  remiseGlobalMontant  Float?        @default(0)
  totalHT              Float         @default(0)
  totalTVA             Float         @default(0)
  totalTTC             Float         @default(0)
  totalPaye            Float         @default(0)
  devise               String?       @default("DZD")
  notes                String?
  conditions           String?
  createdById          String?
  createdBy            User?         @relation("FactureCreatedBy", fields: [createdById], references: [id])
  updatedById          String?
  updatedBy            User?         @relation("FactureUpdatedBy", fields: [updatedById], references: [id])
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt

  lignes               FactureLigne[]
  paiements            Paiement[]
  relances             FactureRelance[]

  // Relations pour les acomptes
  factureFinaleId      String?              // Pour les acomptes: lien vers la facture finale
  factureFinale        Facture?             @relation("AcomptesFacture", fields: [factureFinaleId], references: [id])
  acomptes             Facture[]            @relation("AcomptesFacture")  // Pour la facture finale: liste des acomptes

  @@index([clientId])
  @@index([statut])
  @@index([type])
  @@index([ref])
  @@index([dateFacture])
  @@index([factureFinaleId])
}

model FactureRelance {
  id          String   @id @default(uuid())
  factureId   String
  facture     Facture  @relation(fields: [factureId], references: [id], onDelete: Cascade)
  niveau      Int      @default(1)
  canal       String   // EMAIL, SMS, COURRIER, APPEL
  commentaire String?
  dateRelance DateTime @default(now())
  createdById String?
  createdBy   User?    @relation("FactureRelanceCreatedBy", fields: [createdById], references: [id])
  createdAt   DateTime @default(now())

  @@index([factureId])
  @@index([dateRelance])
}

model FactureLigne {
  id               String         @id @default(uuid())
  factureId        String
  facture          Facture        @relation(fields: [factureId], references: [id], onDelete: Cascade)
  produitServiceId String?
  produitService   ProduitService? @relation(fields: [produitServiceId], references: [id])
  libelle          String
  description      String?
  quantite         Float          @default(1)
  unite            String?
  prixUnitaireHT   Float          @default(0)
  tauxTVA          Float          @default(0)
  remisePct        Float?         @default(0)
  totalHT          Float          @default(0)
  totalTVA         Float          @default(0)
  totalTTC         Float          @default(0)
  ordre            Int            @default(0)

  @@index([factureId])
  @@index([produitServiceId])
}

model Paiement {
  id             String         @id @default(uuid())
  factureId      String
  facture        Facture        @relation(fields: [factureId], references: [id], onDelete: Cascade)
  modePaiementId String?
  modePaiement   ModePaiement?  @relation(fields: [modePaiementId], references: [id])
  datePaiement   DateTime       @default(now())
  montant        Float
  reference      String?
  notes          String?
  statut         PaiementStatut @default(RECU)
  createdById    String?
  createdBy      User?          @relation("PaiementCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime       @default(now())

  @@index([factureId])
  @@index([datePaiement])
}

// ============ GESTION RH - CONGES ET RECUPERATION ============

enum TypeConge {
  ANNUEL           // Congé annuel
  MALADIE          // Arrêt maladie
  RECUPERATION     // Jour de récupération (weekend travaillé)
  SANS_SOLDE       // Congé sans solde
  EXCEPTIONNEL     // Événement familial, etc.
}

enum StatutConge {
  EN_ATTENTE
  APPROUVE
  REFUSE
  ANNULE
}

model Conge {
  id          String       @id @default(uuid())
  employeId   String
  employe     Employe      @relation(fields: [employeId], references: [id])
  type        TypeConge
  dateDebut   DateTime
  dateFin     DateTime
  nbJours     Float        // Nombre de jours (peut être 0.5 pour demi-journée)
  motif       String?
  statut      StatutConge  @default(EN_ATTENTE)
  approuveParId String?
  approuvePar User?        @relation("ApprouvePar", fields: [approuveParId], references: [id])
  dateReponse DateTime?
  commentaire String?      // Commentaire lors de l'approbation/refus
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([employeId])
  @@index([dateDebut])
  @@index([statut])
}

// Suivi des jours de weekend travaillés
model JourWeekendTravaille {
  id          String   @id @default(uuid())
  employeId   String
  employe     Employe  @relation(fields: [employeId], references: [id])
  date        DateTime // La date du jour travaillé (vendredi ou samedi)
  estVendredi Boolean  // true = vendredi, false = samedi
  notes       String?
  createdAt   DateTime @default(now())

  @@unique([employeId, date]) // Un employé ne peut avoir qu'une entrée par jour
  @@index([employeId])
  @@index([date])
}

// Solde des congés par employé et par année
model SoldeConge {
  id              String    @id @default(uuid())
  employeId       String
  employe         Employe   @relation(fields: [employeId], references: [id])
  annee           Int       // L'année concernée
  type            TypeConge
  joursAcquis     Float     @default(0) // Jours acquis/alloués
  joursPris       Float     @default(0) // Jours utilisés
  joursRestants   Float     @default(0) // Calculé: acquis - pris
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeId, annee, type])
  @@index([employeId])
  @@index([annee])
}

// ============ COMMANDES FOURNISSEURS ============

enum CommandeFournisseurStatut {
  BROUILLON
  ENVOYEE
  CONFIRMEE
  EN_RECEPTION
  RECUE
  ANNULEE
}

model CommandeFournisseur {
  id                     String                    @id @default(uuid())
  ref                    String                    @unique
  fournisseurId          String
  fournisseur            Client                    @relation("CommandesFournisseur", fields: [fournisseurId], references: [id])
  dateCommande           DateTime                  @default(now())
  dateLivraisonSouhaitee DateTime?
  dateLivraison          DateTime?
  statut                 CommandeFournisseurStatut @default(BROUILLON)
  remiseGlobalPct        Float?                    @default(0)
  remiseGlobalMontant    Float?                    @default(0)
  totalHT                Float                     @default(0)
  totalTVA               Float                     @default(0)
  totalTTC               Float                     @default(0)
  devise                 String?                   @default("DZD")
  notes                  String?
  conditions             String?
  createdById            String?
  createdBy              User?                     @relation("CommandeFournisseurCreatedBy", fields: [createdById], references: [id])
  updatedById            String?
  updatedBy              User?                     @relation("CommandeFournisseurUpdatedBy", fields: [updatedById], references: [id])
  createdAt              DateTime                  @default(now())
  updatedAt              DateTime                  @updatedAt

  lignes               CommandeFournisseurLigne[]
  facturesFournisseur  FactureFournisseur[]

  @@index([fournisseurId])
  @@index([statut])
  @@index([ref])
  @@index([dateCommande])
}

model CommandeFournisseurLigne {
  id                    String              @id @default(uuid())
  commandeFournisseurId String
  commandeFournisseur   CommandeFournisseur @relation(fields: [commandeFournisseurId], references: [id], onDelete: Cascade)
  produitServiceId      String?
  produitService        ProduitService?     @relation(fields: [produitServiceId], references: [id])
  libelle               String
  description           String?
  quantite              Float               @default(1)
  unite                 String?
  prixUnitaireHT        Float               @default(0)
  tauxTVA               Float               @default(0)
  remisePct             Float?              @default(0)
  totalHT               Float               @default(0)
  totalTVA              Float               @default(0)
  totalTTC              Float               @default(0)
  quantiteRecue         Float               @default(0)
  ordre                 Int                 @default(0)

  @@index([commandeFournisseurId])
  @@index([produitServiceId])
}

// ============ FACTURES FOURNISSEURS ============

enum FactureFournisseurStatut {
  BROUILLON
  VALIDEE
  EN_RETARD
  PARTIELLEMENT_PAYEE
  PAYEE
  ANNULEE
}

model FactureFournisseur {
  id                    String                   @id @default(uuid())
  ref                   String                   @unique
  refFournisseur        String?                  // Référence de la facture chez le fournisseur
  fournisseurId         String
  fournisseur           Client                   @relation("FacturesFournisseur", fields: [fournisseurId], references: [id])
  commandeFournisseurId String?
  commandeFournisseur   CommandeFournisseur?     @relation(fields: [commandeFournisseurId], references: [id])
  dateFacture           DateTime                 @default(now())
  dateEcheance          DateTime?
  dateReception         DateTime?                // Date de réception de la facture
  statut                FactureFournisseurStatut @default(BROUILLON)
  remiseGlobalPct       Float?                   @default(0)
  remiseGlobalMontant   Float?                   @default(0)
  totalHT               Float                    @default(0)
  totalTVA              Float                    @default(0)
  totalTTC              Float                    @default(0)
  totalPaye             Float                    @default(0)
  devise                String?                  @default("DZD")
  notes                 String?
  conditions            String?
  createdById           String?
  createdBy             User?                    @relation("FactureFournisseurCreatedBy", fields: [createdById], references: [id])
  updatedById           String?
  updatedBy             User?                    @relation("FactureFournisseurUpdatedBy", fields: [updatedById], references: [id])
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  lignes                FactureFournisseurLigne[]
  paiements             PaiementFournisseur[]

  @@index([fournisseurId])
  @@index([statut])
  @@index([ref])
  @@index([dateFacture])
}

model FactureFournisseurLigne {
  id                   String              @id @default(uuid())
  factureFournisseurId String
  factureFournisseur   FactureFournisseur  @relation(fields: [factureFournisseurId], references: [id], onDelete: Cascade)
  produitServiceId     String?
  produitService       ProduitService?     @relation("FactureFournisseurLignes", fields: [produitServiceId], references: [id])
  libelle              String
  description          String?
  quantite             Float               @default(1)
  unite                String?
  prixUnitaireHT       Float               @default(0)
  tauxTVA              Float               @default(0)
  remisePct            Float?              @default(0)
  totalHT              Float               @default(0)
  totalTVA             Float               @default(0)
  totalTTC             Float               @default(0)
  ordre                Int                 @default(0)

  @@index([factureFournisseurId])
  @@index([produitServiceId])
}

model PaiementFournisseur {
  id                   String              @id @default(uuid())
  factureFournisseurId String
  factureFournisseur   FactureFournisseur  @relation(fields: [factureFournisseurId], references: [id], onDelete: Cascade)
  modePaiementId       String?
  modePaiement         ModePaiement?       @relation("PaiementsFournisseur", fields: [modePaiementId], references: [id])
  datePaiement         DateTime            @default(now())
  montant              Float
  reference            String?             // Référence du virement/chèque
  banque               String?             // Banque émettrice
  notes                String?
  statut               PaiementStatut      @default(RECU)
  createdById          String?
  createdBy            User?               @relation("PaiementFournisseurCreatedBy", fields: [createdById], references: [id])
  createdAt            DateTime            @default(now())

  @@index([factureFournisseurId])
  @@index([datePaiement])
}

// ============ CHARGES & DEPENSES ============

enum TypeCharge {
  FOURNISSEUR    // Charge liée à un fournisseur
  FISCALE        // Impôts, taxes (hors TVA)
  SOCIALE        // Charges sociales, CNAS, CASNOS
  DIVERSE        // Autres charges (loyer, utilities, etc.)
}

enum ChargeStatut {
  A_PAYER
  PARTIELLEMENT_PAYEE
  PAYEE
  ANNULEE
}

model Charge {
  id                  String       @id @default(uuid())
  ref                 String       @unique
  typeCharge          TypeCharge
  libelle             String
  description         String?

  // Fournisseur (pour type FOURNISSEUR)
  fournisseurId       String?
  fournisseur         Client?      @relation("ChargesFournisseur", fields: [fournisseurId], references: [id])

  // Catégorisation
  categorie           String?      // Ex: "Loyer", "Electricité", "IS", "TVA", "CNAS"
  sousCategorie       String?      // Ex: "Bureaux", "Entrepôt"

  // Dates
  dateCharge          DateTime     @default(now())  // Date de la charge
  dateEcheance        DateTime?                     // Date limite de paiement
  periodeDebut        DateTime?                     // Début de la période concernée
  periodeFin          DateTime?                     // Fin de la période concernée

  // Montants
  montantHT           Float        @default(0)
  tauxTVA             Float        @default(0)
  montantTVA          Float        @default(0)
  montantTTC          Float        @default(0)
  montantPaye         Float        @default(0)

  devise              String?      @default("DZD")
  statut              ChargeStatut @default(A_PAYER)

  // Récurrence
  estRecurrente       Boolean      @default(false)
  frequenceRecurrence String?      // MENSUELLE, TRIMESTRIELLE, ANNUELLE

  notes               String?
  pieceJointe         String?      // Chemin vers document justificatif

  createdById         String?
  createdBy           User?        @relation("ChargeCreatedBy", fields: [createdById], references: [id])
  updatedById         String?
  updatedBy           User?        @relation("ChargeUpdatedBy", fields: [updatedById], references: [id])
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  paiements           PaiementCharge[]

  @@index([typeCharge])
  @@index([categorie])
  @@index([dateCharge])
  @@index([dateEcheance])
  @@index([statut])
}

model PaiementCharge {
  id             String         @id @default(uuid())
  chargeId       String
  charge         Charge         @relation(fields: [chargeId], references: [id], onDelete: Cascade)
  modePaiementId String?
  modePaiement   ModePaiement?  @relation("PaiementsCharge", fields: [modePaiementId], references: [id])
  datePaiement   DateTime       @default(now())
  montant        Float
  reference      String?
  banque         String?
  notes          String?
  statut         PaiementStatut @default(RECU)
  createdById    String?
  createdBy      User?          @relation("PaiementChargeCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime       @default(now())

  @@index([chargeId])
  @@index([datePaiement])
}

// ============ PAIEMENTS DIVERS ============

model PaiementDivers {
  id             String         @id @default(uuid())
  ref            String         @unique
  libelle        String
  description    String?

  // Type
  typeOperation  String         // ENCAISSEMENT, DECAISSEMENT
  categorie      String?        // Classement libre

  // Tiers (optionnel)
  tiersId        String?
  tiers          Client?        @relation("PaiementsDivers", fields: [tiersId], references: [id])

  // Montant
  montant        Float
  devise         String?        @default("DZD")

  // Paiement
  datePaiement   DateTime       @default(now())
  modePaiementId String?
  modePaiement   ModePaiement?  @relation("PaiementsDivers", fields: [modePaiementId], references: [id])
  reference      String?
  banque         String?

  notes          String?
  statut         String         @default("EFFECTUE") // EFFECTUE, ANNULE

  createdById    String?
  createdBy      User?          @relation("PaiementDiversCreatedBy", fields: [createdById], references: [id])
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@index([typeOperation])
  @@index([categorie])
  @@index([datePaiement])
  @@index([tiersId])
}
