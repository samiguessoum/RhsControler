generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  DIRECTION
  PLANNING
  EQUIPE
  LECTURE
}

enum ContratType {
  ANNUEL
  PONCTUEL
}

enum ContratStatut {
  ACTIF
  SUSPENDU
  TERMINE
}

enum Frequence {
  HEBDOMADAIRE
  MENSUELLE
  TRIMESTRIELLE
  SEMESTRIELLE
  ANNUELLE
  PERSONNALISEE
}

enum InterventionType {
  OPERATION
  CONTROLE
  RECLAMATION
  PREMIERE_VISITE
  DEPLACEMENT_COMMERCIAL
}

enum InterventionStatut {
  A_PLANIFIER
  PLANIFIEE
  REALISEE
  REPORTEE
  ANNULEE
}


model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  nom       String
  prenom    String
  tel       String?
  role      Role     @default(EQUIPE)
  actif     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  contratsResponsable Contrat[]        @relation("ResponsablePlanning")
  interventionsCrees  Intervention[]   @relation("CreatedBy")
  interventionsModif  Intervention[]   @relation("UpdatedBy")
  auditLogs           AuditLog[]
  mouvementsStock     MouvementStock[]
  congesApprouves     Conge[]          @relation("ApprouvePar")
}

model Employe {
  id        String               @id @default(uuid())
  prenom    String
  nom       String
  postes    Poste[]
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  interventionEmployes  InterventionEmploye[]
  conges                Conge[]
  joursWeekendTravailles JourWeekendTravaille[]
  soldesConges          SoldeConge[]
}

model Poste {
  id        String    @id @default(uuid())
  nom       String    @unique
  actif     Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  employes             Employe[]
  interventionEmployes InterventionEmploye[]
}

model Client {
  id              String   @id @default(uuid())
  nomEntreprise   String
  secteur         String?
  siegeNom        String
  siegeAdresse    String?
  siegeTel        String?
  siegeEmail      String?
  siegeNotes      String?
  siegeRC         String?
  siegeNIF        String?
  siegeAI         String?
  siegeNIS        String?
  siegeTIN        String?
  actif           Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contrats      Contrat[]
  interventions Intervention[]
  sites         Site[]
  siegeContacts SiegeContact[]
}

model SiegeContact {
  id        String   @id @default(uuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id])
  nom       String
  fonction  String
  tel       String
  email     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

model Site {
  id              String   @id @default(uuid())
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id])
  nom             String
  adresse         String?
  contactNom      String?
  contactFonction String?
  tel             String?
  email           String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contratSites    ContratSite[]
  interventions   Intervention[]

  @@index([clientId])
}

model Contrat {
  id                       String        @id @default(uuid())
  clientId                 String
  client                   Client        @relation(fields: [clientId], references: [id])
  type                     ContratType
  dateDebut                DateTime
  dateFin                  DateTime?
  reconductionAuto         Boolean       @default(false)
  prestations              String[]
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  responsablePlanningId    String?
  responsablePlanning      User?         @relation("ResponsablePlanning", fields: [responsablePlanningId], references: [id])
  statut                   ContratStatut @default(ACTIF)
  notes                    String?
  autoCreerProchaine       Boolean       @default(true)
  // Champs spécifiques au contrat ponctuel
  numeroBonCommande        String?
  nombreOperations         Int?
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt

  interventions Intervention[]
  contratSites  ContratSite[]

  @@index([clientId])
  @@index([statut])
}

model ContratSite {
  id                       String     @id @default(uuid())
  contratId                String
  contrat                  Contrat    @relation(fields: [contratId], references: [id], onDelete: Cascade)
  siteId                   String
  site                     Site       @relation(fields: [siteId], references: [id])
  prestations              String[]   @default([])
  frequenceOperations      Frequence?
  frequenceOperationsJours Int?
  frequenceControle        Frequence?
  frequenceControleJours   Int?
  premiereDateOperation    DateTime?
  premiereDateControle     DateTime?
  nombreOperations         Int?
  nombreVisitesControle    Int?
  notes                    String?
  createdAt                DateTime   @default(now())
  updatedAt                DateTime   @updatedAt

  @@unique([contratId, siteId])
  @@index([contratId])
  @@index([siteId])
}

model Intervention {
  id           String             @id @default(uuid())
  contratId    String?
  contrat      Contrat?           @relation(fields: [contratId], references: [id])
  clientId     String
  client       Client             @relation(fields: [clientId], references: [id])
  siteId       String?
  site         Site?              @relation(fields: [siteId], references: [id])
  type         InterventionType
  prestation   String?
  datePrevue   DateTime
  dateRealisee DateTime?
  heurePrevue  String?
  duree        Int?
  statut       InterventionStatut @default(A_PLANIFIER)
  notesTerrain String?
  responsable  String?
  exporteGCal  Boolean            @default(false)
  createdById  String
  createdBy    User               @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById  String?
  updatedBy    User?              @relation("UpdatedBy", fields: [updatedById], references: [id])
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt

  interventionEmployes InterventionEmploye[]
  mouvementsStock      MouvementStock[]

  @@index([clientId])
  @@index([contratId])
  @@index([siteId])
  @@index([datePrevue])
  @@index([statut])
}

model InterventionEmploye {
  id             String       @id @default(uuid())
  interventionId String
  intervention   Intervention @relation(fields: [interventionId], references: [id], onDelete: Cascade)
  employeId      String
  employe        Employe      @relation(fields: [employeId], references: [id])
  posteId        String
  poste          Poste        @relation(fields: [posteId], references: [id])
  createdAt      DateTime     @default(now())

  @@unique([interventionId, employeId, posteId])
  @@index([interventionId])
  @@index([employeId])
}

model Prestation {
  id        String   @id @default(uuid())
  nom       String   @unique
  description String?
  actif     Boolean  @default(true)
  ordre     Int      @default(0)
  createdAt DateTime @default(now())
}

model AuditLog {
  id        String   @id @default(uuid())
  action    String
  entity    String
  entityId  String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  diff      Json?
  createdAt DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId])
}

// ============ GESTION DES STOCKS ============
model Produit {
  id           String           @id @default(uuid())
  reference    String           @unique
  nom          String
  description  String?
  unite        String           @default("unité") // unité, L, Kg, m², etc.
  quantite     Float            @default(0)
  stockMinimum Float            @default(0) // Seuil d'alerte
  prixUnitaire Float?           // Prix unitaire (optionnel)
  actif        Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  mouvements MouvementStock[]

  @@index([reference])
  @@index([nom])
}

enum TypeMouvement {
  ENTREE
  SORTIE
  AJUSTEMENT
}

model MouvementStock {
  id             String         @id @default(uuid())
  produitId      String
  produit        Produit        @relation(fields: [produitId], references: [id])
  type           TypeMouvement
  quantite       Float          // Quantité (toujours positive, le type détermine +/-)
  quantiteAvant  Float          // Stock avant le mouvement
  quantiteApres  Float          // Stock après le mouvement
  motif          String?        // Raison du mouvement
  interventionId String?        // Lien optionnel avec une intervention
  intervention   Intervention?  @relation(fields: [interventionId], references: [id])
  userId         String
  user           User           @relation(fields: [userId], references: [id])
  createdAt      DateTime       @default(now())

  @@index([produitId])
  @@index([interventionId])
  @@index([userId])
  @@index([createdAt])
}

// ============ GESTION RH - CONGES ET RECUPERATION ============

enum TypeConge {
  ANNUEL           // Congé annuel
  MALADIE          // Arrêt maladie
  RECUPERATION     // Jour de récupération (weekend travaillé)
  SANS_SOLDE       // Congé sans solde
  EXCEPTIONNEL     // Événement familial, etc.
}

enum StatutConge {
  EN_ATTENTE
  APPROUVE
  REFUSE
  ANNULE
}

model Conge {
  id          String       @id @default(uuid())
  employeId   String
  employe     Employe      @relation(fields: [employeId], references: [id])
  type        TypeConge
  dateDebut   DateTime
  dateFin     DateTime
  nbJours     Float        // Nombre de jours (peut être 0.5 pour demi-journée)
  motif       String?
  statut      StatutConge  @default(EN_ATTENTE)
  approuveParId String?
  approuvePar User?        @relation("ApprouvePar", fields: [approuveParId], references: [id])
  dateReponse DateTime?
  commentaire String?      // Commentaire lors de l'approbation/refus
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([employeId])
  @@index([dateDebut])
  @@index([statut])
}

// Suivi des jours de weekend travaillés
model JourWeekendTravaille {
  id          String   @id @default(uuid())
  employeId   String
  employe     Employe  @relation(fields: [employeId], references: [id])
  date        DateTime // La date du jour travaillé (vendredi ou samedi)
  estVendredi Boolean  // true = vendredi, false = samedi
  notes       String?
  createdAt   DateTime @default(now())

  @@unique([employeId, date]) // Un employé ne peut avoir qu'une entrée par jour
  @@index([employeId])
  @@index([date])
}

// Solde des congés par employé et par année
model SoldeConge {
  id              String    @id @default(uuid())
  employeId       String
  employe         Employe   @relation(fields: [employeId], references: [id])
  annee           Int       // L'année concernée
  type            TypeConge
  joursAcquis     Float     @default(0) // Jours acquis/alloués
  joursPris       Float     @default(0) // Jours utilisés
  joursRestants   Float     @default(0) // Calculé: acquis - pris
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeId, annee, type])
  @@index([employeId])
  @@index([annee])
}
